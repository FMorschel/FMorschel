name: Update Dart SDK Commit Badge

on:
  schedule:
    - cron: "0 0 * * *" # Runs daily at midnight UTC
  workflow_dispatch: # Allows manual runs

jobs:
  update-badge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Count Commits
      id: count-commits
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        API_URL="https://api.github.com/repos/dart-lang/sdk/commits?author=FMorschel&per_page=100"
        PAGE=1
        COUNT=0

        while true; do
          RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "${API_URL}&page=${PAGE}")
          LENGTH=$(echo "$RESPONSE" | jq length)
          if [ "$LENGTH" -eq 0 ]; then
            break
          fi
          COUNT=$((COUNT + LENGTH))
          PAGE=$((PAGE + 1))
        done

        echo "commit_count=$COUNT" >> $GITHUB_ENV

    - name: Generate Badge
      run: |
        COMMIT_COUNT=${{ env.commit_count }}
        BADGE_URL="https://img.shields.io/badge/Dart%20SDK%20Commits-${COMMIT_COUNT}-brightgreen"
        curl -s "$BADGE_URL" -o commits.svg

    - name: Commit and Push Badge
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add commits.svg
        git commit -m "Update commit badge to ${COMMIT_COUNT}"
        git push
